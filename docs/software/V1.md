---
sidebar_position: 0
---

# Software V1

Pour réaliser l'ensemble de nos tests nous avons mis en place un broker MQTT à l'adresse 178.170.38.88 et le port 55555.

## Fonctionnalités prises en compte 

### Connexion wifi

Pour pouvoir reçevoir les commandes via MQTT, la esp32c3 doit pouvoir se connecter à un réseau wifi stable.  
Les fonctionnalités wifi de la carte sont disponibles via la librairie **WiFi.h**, qui permet de scanner les wifis des alentours et de s'y connecter si besoin.  
Les fonctions `ScanWifi` et `connectToWifi` permettent de scanner les wifis environnants et de s'y connecter en renseignant le SSID et le mot de passe au préalable.  
Dans la version actuelle, le SSID et le mot de passe sont entrés en dur au début du programme (à changer dans une version future).  
À savoir que le programme ne démarre pas si une connexion wifi n'est pas établie ou si celle-ci n'est pas assez puissante.

### Connexion au broker MQTT

La réception des commandes du bracelet se fait via MQTT. Une connexion continue et robuste est nécessaire. La bibliothèque **PubSubClient.h** fournit tous les outils nécessaires.  
Plusieurs fonctions sont responsables de la gestion du MQTT :  

- **`connectToBroker`** : Cette fonction se connecte au serveur via la méthode `setServer` en paramétrant l'adresse IP du broker et le port de communication.  
La connexion au broker doit durer pendant tout le vol ; il est donc important de prioriser les reconnexions au broker en cas de déconnexion. Ce code tente de se reconnecter au broker en cas de déconnexion. Cette fonction est aussi responsable de l'abonnement aux topics via la méthode `subscribe(topic)`.

- **`Callback`** : C'est la fonction qui est appelée lors de la réception d'un message. Cette fonction prend 3 paramètres :  
  - `char *topic` : le topic sur lequel le message a été réceptionné,  
  - `byte *payload` : le message réceptionné lui-même,  
  - `unsigned int length` : la taille du message.  

L'idée de cette fonction est d'exécuter les commandes reçues via MQTT sur les différents topics possibles en analysant le message et exécutant l'ordre correspondant.  
Dans l'état actuel, la fonction `Callback` reçoit un premier message de configuration sur le topic `/config/`, qui permet de configurer les patterns vibratoires à jouer en fonction du message reçu.  
Elle le décode avec JSON et attribue le pattern à l'alerte. Ensuite, les réceptions se font sur le topic `/pattern/`, qui envoie les commandes au bracelet.  

Exemples de messages :  
- **Config** :  
  ```bash
  mosquitto_pub -h 178.170.38.88 -t /config/ -m '{"alert":"2,56,2,56"}' -p 55555

   
